<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <title>Entregas da Atividade - LeanCore</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width" />
  <link rel="stylesheet" href="./css/atividadeDetalhe.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">LeanCore</div>
    <nav>
            <ul class="sidebar-nav">
        <li><a href="./dashBoardProf.html" ><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="./turmasProf.html"><i class="fas fa-users"></i> Turmas</a></li>
        <li><a href="./atividadesProf.html"class="active"><i class="fas fa-tasks"></i> Atividades</a></li>
        <li><a href="./dadosProf.html"><i class="fas fa-cog"></i> Configurações</a></li>
        <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
      </ul>
    </nav>
  </aside>

  <!-- Header -->
  <header class="header">
    <h1>Entregas da Atividade</h1>
    <div class="header-right">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Pesquisar aluno..." id="searchInput" />
      </div>
      <div class="notifications">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationCount">0</span>
      </div>
      <div class="user-profile">
        <img src="https://i.pravatar.cc/32" alt="Foto do perfil" class="avatar" id="userAvatar" />
        <span id="professorName">Carregando...</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="activity-container">
      <!-- Cabeçalho da Atividade -->
      <div class="activity-header">
        <div class="activity-info">
          <h1 id="titulo-atividade">Carregando atividade...</h1>
          <div class="activity-meta">
            <span id="turma-atividade"><i class="fas fa-users"></i> Turma: Carregando...</span>
            <span id="data-criacao"><i class="far fa-calendar"></i> Criada em: Carregando...</span>
          </div>
        </div>
        
        <div class="activity-stats">
          <div class="stat-card">
            <div class="stat-value" id="total-alunos">0</div>
            <div class="stat-label">Alunos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="entregas-count">0</div>
            <div class="stat-label">Entregas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="corrigidas-count">0</div>
            <div class="stat-label">Corrigidas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="valor-atividade">0</div>
            <div class="stat-label">Pontos</div>
          </div>
        </div>
      </div>

      <!-- Prazo e Status -->
      <div class="deadline-status">
        <div class="deadline-info">
          <i class="fas fa-clock"></i>
          <div>
            <span class="deadline-label">Prazo de Entrega:</span>
            <span id="data-entrega" class="deadline-date">Carregando...</span>
          </div>
        </div>
        <div class="status-info">
          <span class="status-badge" id="status-atividade">Status: Carregando...</span>
          <span class="status-badge" id="progresso-atividade">Progresso: 0%</span>
        </div>
      </div>

      <!-- Tabela de Entregas -->
      <div class="deliveries-container">
        <div class="table-header">
          <h2>Entregas dos Alunos</h2>
          <div class="table-actions">
            <button class="btn btn-outline" id="export-btn">
              <i class="fas fa-file-export"></i> Exportar
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="deliveries-table">
            <thead>
              <tr>
                <th>Aluno</th>
                <th>Status</th>
                <th>Data de Entrega</th>
                <th>Nota</th>
                <th>Feedback</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="entregas-table-body">
              <tr>
                <td colspan="6" class="loading-row">
                  <i class="fas fa-spinner fa-spin"></i> Carregando entregas...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Funções auxiliares
    function formatarData(dataString) {
      if (!dataString) return '-';
      const options = { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit', 
        minute: '2-digit'
      };
      return new Date(dataString).toLocaleDateString('pt-BR', options);
    }

    function getStatusClass(status) {
      const statusClasses = {
        'pendente': 'status-pending',
        'entregue': 'status-delivered',
        'atrasada': 'status-late',
        'corrigida': 'status-corrected'
      };
      return statusClasses[status] || 'status-pending';
    }

    function getStatusText(status) {
      const statusTexts = {
        'pendente': 'Pendente',
        'entregue': 'Entregue',
        'atrasada': 'Atrasada',
        'corrigida': 'Corrigida'
      };
      return statusTexts[status] || status;
    }

    function getNotaClass(nota, total) {
      if (!nota || !total) return '';
      const percent = (nota / total) * 100;
      
      if (percent >= 80) return 'nota-excelente';
      if (percent >= 60) return 'nota-boa';
      if (percent >= 40) return 'nota-regular';
      return 'nota-ruim';
    }

    // Função principal para renderizar as entregas
    async function renderizarEntregas(atividade) {
      // Atualiza informações do cabeçalho
      document.getElementById('titulo-atividade').textContent = atividade.titulo;
      document.getElementById('turma-atividade').textContent = `Turma: ${atividade.turmas.map(t => t.nome).join(', ') || 'Sem turma'}`;
      document.getElementById('data-criacao').textContent = `Criada em: ${formatarData(atividade.createdAt)}`;
      document.getElementById('data-entrega').textContent = formatarData(atividade.dataEntrega);
      document.getElementById('valor-atividade').textContent = atividade.valor;

      // Calcula estatísticas
      const totalAlunos = atividade.alunosAtribuidos?.length || 0;
      const entregasCount = atividade.entregas?.length || 0;
      const corrigidasCount = atividade.entregas?.filter(e => e.status === 'corrigida').length || 0;
      const progresso = totalAlunos > 0 ? Math.round((entregasCount / totalAlunos) * 100) : 0;

      // Atualiza os cards de estatísticas
      document.getElementById('total-alunos').textContent = totalAlunos;
      document.getElementById('entregas-count').textContent = entregasCount;
      document.getElementById('corrigidas-count').textContent = corrigidasCount;
      
      // Atualiza status da atividade
      document.getElementById('status-atividade').textContent = `Status: ${atividade.statusGeral}`;
      document.getElementById('progresso-atividade').textContent = `Progresso: ${progresso}%`;

      // Renderiza a tabela de entregas
      const tableBody = document.getElementById('entregas-table-body');
      tableBody.innerHTML = '';

      if (!atividade.alunosAtribuidos || atividade.alunosAtribuidos.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-row">
              Nenhum aluno atribuído a esta atividade
            </td>
          </tr>
        `;
        return;
      }

      // Ordena alunos por nome
      const alunosOrdenados = [...atividade.alunosAtribuidos].sort((a, b) => 
        a.fullName.localeCompare(b.fullName)
      );

      // Para cada aluno, cria uma linha na tabela
      alunosOrdenados.forEach(aluno => {
        const entrega = atividade.entregas?.find(e => 
          e.aluno._id === aluno._id || e.aluno === aluno._id
        );
        
        // Determina o status da entrega
        let status = 'pendente';
        if (entrega) {
          if (entrega.status === 'corrigida') {
            status = 'corrigida';
          } else {
            const dataEntrega = new Date(entrega.dataEntrega);
            const dataLimite = new Date(atividade.dataEntrega);
            status = dataEntrega <= dataLimite ? 'entregue' : 'atrasada';
          }
        }

        const nota = entrega?.feedback?.nota;
        const feedback = entrega?.feedback?.texto || '-';
        const dataEntrega = entrega?.dataEntrega ? formatarData(entrega.dataEntrega) : '-';

       

// Supondo que o objeto aluno tem uma propriedade 'user' que contém os dados do usuário
const user = aluno.user || aluno; // pega o objeto user associado, ou o próprio aluno se for user

const avatarPath = user.avatar;
const avatarUrl = avatarPath
  ? (avatarPath.startsWith('http') ? avatarPath : `http://localhost:3000/${avatarPath.replace(/\\/g, '/')}`)
  : `https://i.pravatar.cc/40?u=${user.email}`;

const row = document.createElement('tr');
row.innerHTML = `
  <td>
    <div class="student-info">
      <img src="${avatarUrl}" alt="${user.fullName}" class="avatar">
      <div>
        <div class="student-name">${user.fullName}</div>
        <div class="student-email">${user.email}</div>
      </div>
    </div>
  </td>
  <td>
    <span class="status-badge ${getStatusClass(status)}">
      ${getStatusText(status)}
    </span>
  </td>
  <td>${dataEntrega}</td>
  <td class="${getNotaClass(nota, atividade.valor)}">
    ${nota ? `${nota}/${atividade.valor}` : '-'}
  </td>
  <td class="feedback-cell">${feedback}</td>
  <td>
    <div class="action-buttons">
      ${entrega ? `
        <button class="btn-icon view-btn" onclick="visualizarEntrega('${atividade._id}', '${aluno._id}')" title="Visualizar">
          <i class="fas fa-eye"></i>
        </button>
        ${status !== 'corrigida' ? `
          <button class="btn-icon correct-btn" onclick="corrigirEntrega('${atividade._id}', '${aluno._id}')" title="Corrigir">
            <i class="fas fa-check-circle"></i>
          </button>
        ` : ''}
      ` : `
        <button class="btn-icon remind-btn" onclick="enviarLembrete('${atividade._id}', '${aluno._id}')" title="Enviar lembrete">
          <i class="fas fa-bell"></i>
        </button>
      `}
    </div>
  </td>
`;
tableBody.appendChild(row);


      });
    }

    // Função para carregar os dados da atividade
    async function carregarAtividade() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const atividadeId = urlParams.get('id');

        if (!atividadeId) {
          throw new Error('ID da atividade não encontrado na URL');
        }

        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        const headers = {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        };

        // Carrega dados do usuário
        const userRes = await fetch('http://localhost:3000/api/users/me', { headers });
        if (!userRes.ok) throw new Error('Erro ao carregar dados do usuário');
        const userData = await userRes.json();
        
        // Atualiza cabeçalho com nome do professor
       const professorNome = `${userData.data.firstName} ${userData.data.lastName}`;
document.getElementById('professorName').textContent = `Prof. ${professorNome}`;

// Avatar do professor
const profAvatarPath = userData.data.avatar?.replace(/\\/g, '/');
const profAvatarURL = profAvatarPath?.startsWith('http')
  ? profAvatarPath
  : `http://localhost:3000/${profAvatarPath}`;
document.getElementById('userAvatar').src = profAvatarURL || `https://i.pravatar.cc/40?u=${userData.data.email}`;


        // Carrega dados da atividade
        const atividadeRes = await fetch(`http://localhost:3000/api/tarefas/${atividadeId}`, { headers });
        if (!atividadeRes.ok) throw new Error('Erro ao carregar atividade');
        const atividadeData = await atividadeRes.json();

        // Renderiza as entregas
        await renderizarEntregas(atividadeData.data);

      } catch (error) {
        console.error('Erro ao carregar atividade:', error);
        document.getElementById('entregas-table-body').innerHTML = `
          <tr>
            <td colspan="6" class="error-row">
              <i class="fas fa-exclamation-circle"></i> Erro ao carregar dados: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Funções de ação
    function visualizarEntrega(atividadeId, alunoId) {
      window.location.href = `atividadeDetalheProfcorrecao.html?atividadeId=${atividadeId}&alunoId=${alunoId}`;
    }

    function corrigirEntrega(atividadeId, alunoId) {
      window.location.href = `corrigirEntrega.html?atividadeId=${atividadeId}&alunoId=${alunoId}`;
    }

    async function enviarLembrete(atividadeId, alunoId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3000/api/tarefas/${atividadeId}/lembrete/${alunoId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          alert('Lembrete enviado com sucesso!');
        } else {
          throw new Error('Erro ao enviar lembrete');
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Falha ao enviar lembrete: ' + error.message);
      }
    }

    // Logout
    document.getElementById('logout').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    });

    // Inicialização
    document.addEventListener('DOMContentLoaded', carregarAtividade);
  </script>

  <style>
    /* Estilos específicos para esta página */
    .activity-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 24px;
      margin-bottom: 24px;
    }

    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .activity-info h1 {
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .activity-meta {
      display: flex;
      gap: 16px;
      color: #666;
      font-size: 14px;
    }

    .activity-meta i {
      margin-right: 6px;
    }

    .activity-stats {
      display: flex;
      gap: 16px;
    }

    .stat-card {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 12px 16px;
      text-align: center;
      min-width: 80px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
    }

    .stat-label {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 4px;
    }

    .deadline-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 24px;
    }

    .deadline-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .deadline-info i {
      color: #e74c3c;
      font-size: 18px;
    }

    .deadline-label {
      font-size: 12px;
      color: #7f8c8d;
      display: block;
    }

    .deadline-date {
      font-weight: 600;
      color: #2c3e50;
    }

    .status-info {
      display: flex;
      gap: 8px;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-delivered {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-late {
      background: #f8d7da;
      color: #721c24;
    }

    .status-corrected {
      background: #d4edda;
      color: #155724;
    }

    .deliveries-container {
      margin-top: 24px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .table-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .table-responsive {
      overflow-x: auto;
    }

    .deliveries-table {
      width: 100%;
      border-collapse: collapse;
    }

    .deliveries-table th {
      background: #f8f9fa;
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
    }

    .deliveries-table td {
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: middle;
    }

    .deliveries-table tr:last-child td {
      border-bottom: none;
    }

    .deliveries-table tr:hover {
      background: #f8f9fa;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .student-name {
      font-weight: 500;
      color: #1a1a1a;
    }

    .student-email {
      font-size: 12px;
      color: #7f8c8d;
    }

    .feedback-cell {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      transform: scale(1.1);
    }

    .view-btn {
      background: #e3f2fd;
      color: #1976d2;
    }

    .correct-btn {
      background: #e8f5e9;
      color: #388e3c;
    }

    .remind-btn {
      background: #fff3e0;
      color: #ffa000;
    }

    .loading-row, .empty-row, .error-row {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-row i {
      margin-right: 8px;
    }

    .error-row {
      color: #e74c3c;
    }

    .nota-excelente {
      color: #27ae60;
      font-weight: 600;
    }

    .nota-boa {
      color: #2980b9;
      font-weight: 600;
    }

    .nota-regular {
      color: #f39c12;
      font-weight: 600;
    }

    .nota-ruim {
      color: #e74c3c;
      font-weight: 600;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .activity-header {
        flex-direction: column;
        gap: 16px;
      }
      
      .activity-stats {
        width: 100%;
        justify-content: space-between;
      }
      
      .deadline-status {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
    }
  </style>
</body>
</html>