<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <title>LeanCore - Criar Atividade</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="./css/criarAtividade.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
      /* Estilos adicionais para melhorar a visualização */
      .file-upload {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .file-upload:hover {
        border-color: #4e73df;
        background-color: #f8f9fa;
      }
      
      .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 10px;
      }
      
      .file-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 8px;
      }
      
      .file-item i {
        margin-right: 10px;
        font-size: 1.2rem;
      }
      
      .file-item span {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .file-item small {
        margin: 0 10px;
        color: #6c757d;
      }
      
      .file-item .remove-file {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
      }
      
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      }
      
      .notification i {
        margin-right: 10px;
      }
      
      .notification.error {
        background-color: #dc3545;
      }
      
      .notification.success {
        background-color: #28a745;
      }
      
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">LeanCore</div>
      <nav>
              <ul class="sidebar-nav">
        <li><a href="./dashBoardProf.html" ><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="./turmasProf.html"><i class="fas fa-users"></i> Turmas</a></li>
        <li><a href="./atividadesProf.html"class="active"><i class="fas fa-tasks"></i> Atividades</a></li>
        <li><a href="./feedback.html"><i class="fas fa-check-circle"></i> Correções</a></li>
        <li><a href="./dadosProf.html"><i class="fas fa-cog"></i> Configurações</a></li>
        <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
      </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="header">
        <div class="flex-1">
          <h1 class="text-xl font-semibold text-gray-800">Criar Nova Atividade</h1>
        </div>
        <div class="flex items-center gap-4">
          <button class="btn">
            <i class="fas fa-bell"></i>
          </button>
          <div class="flex items-center gap-2">
            <img src="https://ui-avatars.com/api/?name=Professor" alt="Profile" class="w-8 h-8 rounded-full" id="profileImage">
            <span class="text-gray-700" id="profileName">Professor Silva</span>
          </div>
        </div>
      </header>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Form Section -->
        <form class="activity-form" id="activityForm">
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Título da Atividade
            </label>
            <input type="text" name="title" class="input-field" placeholder="Digite o título da atividade" required>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Descrição
            </label>
            <textarea name="description" class="input-field" rows="4" placeholder="Descreva os detalhes da atividade" required maxlength="500"></textarea>
            <div id="characterCount" class="text-sm text-gray-500 mt-1">500 caracteres restantes</div>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Imagem da Atividade
            </label>
            <div class="file-upload" id="imageUpload">
              <i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
              <p>Arraste uma imagem ou clique para selecionar</p>
              <p class="text-sm text-gray-500 mt-1">PNG, JPG ou GIF até 5MB</p>
              <input type="file" id="imageInput" name="imagem" class="hidden" accept="image/*">
            </div>
            <div id="imagePreview" class="hidden mt-4">
              <img id="previewImage" src="#" alt="Preview" class="preview-image">
              <button type="button" class="btn text-sm text-red-500 mt-2" id="removeImageBtn">
                <i class="fas fa-trash"></i> Remover imagem
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Materiais de Apoio (Anexos)
            </label>
            <div class="file-upload" id="fileUpload">
              <i class="fas fa-file-upload text-3xl text-blue-500 mb-2"></i>
              <p>Adicione arquivos complementares</p>
              <p class="text-sm text-gray-500 mt-1">PDF, DOC, PPT até 10MB (máx. 5 arquivos)</p>
              <input type="file" id="fileInput" name="anexos" class="hidden" multiple>
            </div>
            <div id="fileList" class="mt-2"></div>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Matéria
            </label>
            <select name="materia" class="input-field" id="materiaSelect" required>
              <option value="">Selecione uma matéria</option>
              <!-- Opções serão carregadas dinamicamente -->
            </select>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Tipo de Atividade
            </label>
            <select name="tipoAtividade" class="input-field" required>
              <option value="exercicio">Exercício</option>
              <option value="projeto">Projeto</option>
              <option value="trabalho">Trabalho</option>
              <option value="avaliacao">Avaliação</option>
            </select>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Data de Entrega
            </label>
            <input type="date" name="dueDate" class="input-field" id="dueDateInput" required>
            <div id="dueDisplay" class="text-sm text-gray-500 mt-1"></div>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Valor da Atividade
            </label>
            <input type="number" name="value" class="input-field" id="valueInput" 
                   placeholder="Digite o valor da atividade" min="0" max="100" value="10" required>
            <div id="valueDisplay" class="text-sm text-gray-500 mt-1">10 pontos</div>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Selecionar Turmas
            </label>
            <div class="class-select" id="classSelect">
              <div class="loading-content">
                <i class="fas fa-spinner fa-spin"></i> Carregando turmas...
              </div>
            </div>
            <div id="selectedCount" class="text-sm text-gray-500 mt-2">0 turma(s) selecionada(s)</div>
          </div>

          <div class="flex justify-end gap-4">
            <button type="button" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200" id="cancelBtn">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              Criar Atividade
            </button>
          </div>
        </form>

        <!-- Preview Card -->
        <div class="preview-card" id="previewCard">
          <h3 class="text-lg font-semibold mb-4">Preview da Atividade</h3>
          <h4 class="preview-title text-xl font-semibold mb-2" id="previewTitle">Título da Atividade</h4>
          <p class="preview-description text-gray-600 mb-4" id="previewDescription">Descrição da atividade...</p>
          <div class="text-sm text-gray-500">
            <p class="mb-1"><i class="fas fa-clock"></i> <span id="previewDueDate">Data de entrega não definida</span></p>
            <p><i class="fas fa-star"></i> <span id="previewValue">10 pontos</span></p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configuração global
      const API_BASE_URL = 'http://localhost:3000/api';
      let currentUser = null;
      let userSalas = [];
      let materias = [];

      // Elementos da UI
      const elements = {
        form: document.getElementById('activityForm'),
        titleInput: document.querySelector('input[name="title"]'),
        descriptionInput: document.querySelector('textarea[name="description"]'),
        materiaSelect: document.getElementById('materiaSelect'),
        tipoAtividadeSelect: document.querySelector('select[name="tipoAtividade"]'),
        valueInput: document.getElementById('valueInput'),
        dueDateInput: document.getElementById('dueDateInput'),
        imageInput: document.getElementById('imageInput'),
        fileInput: document.getElementById('fileInput'),
        classSelect: document.getElementById('classSelect'),
        fileList: document.getElementById('fileList'),
        imagePreview: document.getElementById('imagePreview'),
        previewImage: document.getElementById('previewImage'),
        submitBtn: document.getElementById('submitBtn'),
        cancelBtn: document.getElementById('cancelBtn'),
        removeImageBtn: document.getElementById('removeImageBtn'),
        previewTitle: document.getElementById('previewTitle'),
        previewDescription: document.getElementById('previewDescription'),
        previewDueDate: document.getElementById('previewDueDate'),
        previewValue: document.getElementById('previewValue'),
        characterCount: document.getElementById('characterCount'),
        selectedCount: document.getElementById('selectedCount'),
        dueDisplay: document.getElementById('dueDisplay'),
        valueDisplay: document.getElementById('valueDisplay'),
        profileName: document.getElementById('profileName'),
        profileImage: document.getElementById('profileImage')
      };

      // Inicialização
      document.addEventListener('DOMContentLoaded', async () => {
        checkAuth();
        setupEventListeners();
        await loadUserData();
        await loadMaterias();
        await loadUserSalas();
        
        // Configura data mínima como hoje
        const today = new Date().toISOString().split('T')[0];
        elements.dueDateInput.min = today;
      });

      // Verifica autenticação
      function checkAuth() {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = 'login.html';
        }
      }

      // Função para fazer requisições autenticadas
      async function fetchAuth(url, options = {}) {
        const token = localStorage.getItem('token');
        
        const response = await fetch(`${API_BASE_URL}${url}`, {
          ...options,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        
        if (response.status === 401) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erro na requisição');
        }
        
        return await response.json();
      }

      // Função para upload de arquivos
      async function uploadFile(file, folder) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('folder', folder);

        try {
          const response = await fetch(`${API_BASE_URL}/upload`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: formData
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Erro no upload');
          }

          return await response.json();
        } catch (error) {
          console.error('Erro no upload:', error);
          throw new Error(`Falha ao enviar arquivo: ${error.message}`);
        }
      }

      // Carrega dados do usuário
async function loadUserData() {
  try {
    const data = await fetchAuth('/users/me');
    currentUser = data.data;

    elements.profileName.textContent = currentUser.fullName;

    if (currentUser.avatar) {
      const avatarPath = currentUser.avatar.replace(/\\/g, '/');
      const avatarUrl = avatarPath.startsWith('http')
        ? avatarPath
        : `http://localhost:3000/${avatarPath}`;
        
      elements.profileImage.src = avatarUrl;
    } else {
      // Avatar padrão caso não exista
      elements.profileImage.src = `https://i.pravatar.cc/150?u=${currentUser.email}`;
    }

  } catch (error) {
    showError('Erro ao carregar dados do usuário');
    console.error(error);
  }
}

      // Carrega matérias disponíveis
      async function loadMaterias() {
        try {
          const response = await fetchAuth('/materias');
          materias = response.data || [];
          
          // Preenche o select de matérias
          elements.materiaSelect.innerHTML = '<option value="">Selecione uma matéria</option>' + 
            materias.map(materia => 
              `<option value="${materia._id}">${materia.nome}</option>`
            ).join('');
        } catch (error) {
          console.error('Erro ao carregar matérias:', error);
          showError('Erro ao carregar matérias. Tente recarregar a página.');
        }
      }

      // Carrega salas do professor
      async function loadUserSalas() {
        try {
          if (!currentUser) {
            await loadUserData();
          }
          
          const response = await fetchAuth(`/salas?professorId=${currentUser._id}`);
          
          if (response.success) {
            userSalas = response.data || [];
          } else {
            try {
              const allSalasResponse = await fetchAuth('/salas');
              userSalas = allSalasResponse.data || [];
            } catch (fallbackError) {
              console.error('Erro no fallback ao carregar salas:', fallbackError);
              userSalas = [];
            }
          }
          
          renderClassOptions();
        } catch (error) {
          console.error('Erro ao carregar turmas:', error);
          showError('Erro ao carregar turmas. Tente recarregar a página.');
          userSalas = [];
          renderClassOptions();
        }
      }

      // Renderiza opções de turmas
      function renderClassOptions() {
        if (userSalas.length === 0) {
          elements.classSelect.innerHTML = '<p class="text-gray-500">Nenhuma turma disponível</p>';
          return;
        }
        
        elements.classSelect.innerHTML = userSalas.map(sala => `
          <div class="class-option" data-id="${sala._id}">
            ${sala.nome}
          </div>
        `).join('');
        
        document.querySelectorAll('.class-option').forEach(option => {
          option.addEventListener('click', function() {
            this.classList.toggle('selected');
            updateSelectedCount();
          });
        });
      }

      // Atualiza contador de turmas selecionadas
      function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.class-option.selected').length;
        elements.selectedCount.textContent = `${selectedCount} turma(s) selecionada(s)`;
      }

      // Configura listeners de eventos
      function setupEventListeners() {
        // Upload de imagem
        elements.imageInput.addEventListener('change', handleImageUpload);
        document.getElementById('imageUpload').addEventListener('click', () => elements.imageInput.click());
        elements.removeImageBtn.addEventListener('click', removeImage);

        // Upload de arquivos
        elements.fileInput.addEventListener('change', handleFileUpload);
        document.getElementById('fileUpload').addEventListener('click', () => elements.fileInput.click());

        // Atualização em tempo real
        elements.titleInput.addEventListener('input', updatePreview);
        elements.descriptionInput.addEventListener('input', updatePreview);
        elements.valueInput.addEventListener('input', updateValueDisplay);
        elements.dueDateInput.addEventListener('input', updateDueDateDisplay);
        elements.descriptionInput.addEventListener('input', updateCharacterCount);

        // Botões
        elements.cancelBtn.addEventListener('click', () => {
          if (confirm('Deseja cancelar a criação desta atividade?')) {
            window.location.href = 'atividadesProf.html';
          }
        });

        // Envio do formulário
        elements.form.addEventListener('submit', handleFormSubmit);
      }

      // Atualiza contador de caracteres
      function updateCharacterCount() {
        const remaining = 500 - elements.descriptionInput.value.length;
        elements.characterCount.textContent = `${remaining} caracteres restantes`;
      }

      // Atualiza display do valor
      function updateValueDisplay() {
        elements.valueDisplay.textContent = `${elements.valueInput.value} pontos`;
        elements.previewValue.textContent = `${elements.valueInput.value} pontos`;
      }

      // Atualiza display da data de entrega
      function updateDueDateDisplay() {
        if (!elements.dueDateInput.value) {
          elements.dueDisplay.textContent = '';
          elements.previewDueDate.textContent = 'Data de entrega não definida';
          return;
        }
        
        const date = new Date(elements.dueDateInput.value);
        const formattedDate = date.toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
        
        elements.dueDisplay.textContent = `Entrega: ${formattedDate}`;
        elements.previewDueDate.textContent = `Entrega: ${formattedDate}`;
      }

      // Atualiza preview da atividade
      function updatePreview() {
        elements.previewTitle.textContent = elements.titleInput.value || 'Título da Atividade';
        elements.previewDescription.textContent = elements.descriptionInput.value || 'Descrição da atividade...';
      }

      // Manipula upload de imagem
      function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
          showError('A imagem deve ter menos que 5MB');
          return;
        }

        if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
          showError('Formato de imagem inválido. Use JPG, PNG ou GIF');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const previewImg = elements.imagePreview.querySelector('#previewImage');
          if (previewImg) {
            previewImg.src = e.target.result;
            elements.imagePreview.classList.remove('hidden');
            document.getElementById('imageUpload').classList.add('hidden');
          }
        };
        reader.readAsDataURL(file);
      }

      // Remove imagem selecionada
      function removeImage() {
        elements.imageInput.value = '';
        elements.imagePreview.classList.add('hidden');
        document.getElementById('imageUpload').classList.remove('hidden');
      }

      // Manipula upload de arquivos
      function handleFileUpload(e) {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        if (files.length > 5) {
          showError('Máximo de 5 arquivos permitidos');
          return;
        }

        elements.fileList.innerHTML = '';

        Array.from(files).forEach(file => {
          if (file.size > 10 * 1024 * 1024) {
            showError(`Arquivo ${file.name} é muito grande (máx. 10MB)`);
            return;
          }

          const validTypes = [
            'application/pdf',
            'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-powerpoint',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation'
          ];
          
          if (!validTypes.includes(file.type)) {
            showError(`Tipo de arquivo não suportado: ${file.name}`);
            return;
          }

          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <i class="${getFileIcon(file.type)}"></i>
            <span>${file.name}</span>
            <small>${formatFileSize(file.size)}</small>
            <button type="button" class="remove-file"><i class="fas fa-times"></i></button>
          `;
          
          fileItem.querySelector('.remove-file').addEventListener('click', () => {
            fileItem.remove();
            updateFileInput();
          });
          
          elements.fileList.appendChild(fileItem);
        });
      }

      // Atualiza o input de arquivos após remoção
      function updateFileInput() {
        const dataTransfer = new DataTransfer();
        const fileItems = elements.fileList.querySelectorAll('.file-item');
        
        fileItems.forEach(item => {
          const fileName = item.querySelector('span').textContent;
          const file = Array.from(elements.fileInput.files).find(f => f.name === fileName);
          if (file) dataTransfer.items.add(file);
        });
        
        elements.fileInput.files = dataTransfer.files;
      }

      // Manipula envio do formulário
      async function handleFormSubmit(e) {
  e.preventDefault();
  
  const selectedClasses = document.querySelectorAll('.class-option.selected');
  if (selectedClasses.length === 0) {
    showError('Selecione pelo menos uma turma');
    return;
  }

  if (!elements.materiaSelect.value) {
    showError('Selecione uma matéria');
    return;
  }

  // Configura estado de loading
  const originalText = elements.submitBtn.innerHTML;
  elements.submitBtn.disabled = true;
  elements.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';

  try {
    // Cria FormData em vez de objeto JSON
    const formData = new FormData();
    
    // Adiciona os campos básicos
    formData.append('titulo', elements.titleInput.value);
    formData.append('descricao', elements.descriptionInput.value);
    formData.append('materia', elements.materiaSelect.value);
    formData.append('tipoAtividade', elements.tipoAtividadeSelect.value);
    formData.append('dataEntrega', elements.dueDateInput.value);
    formData.append('valor', elements.valueInput.value);
    
    // Adiciona turmas selecionadas
    Array.from(selectedClasses).forEach((el, index) => {
      formData.append(`turmas[${index}]`, el.dataset.id);
    });

    // Adiciona a imagem (se existir)
    if (elements.imageInput.files[0]) {
      formData.append('imagem', elements.imageInput.files[0]);
    }

    // Adiciona anexos (se existirem)
    Array.from(elements.fileInput.files).forEach((file, index) => {
      formData.append(`anexos`, file); // Note que é o mesmo nome para múltiplos arquivos
    });

    // Faz a requisição com FormData
    const response = await fetch(`${API_BASE_URL}/tarefas`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: formData // Envia FormData diretamente
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      throw new Error(data.message || 'Erro ao criar tarefa');
    }

    showSuccess('Atividade criada com sucesso!');
    
    // Redireciona para a página de detalhes
    setTimeout(() => {
      window.location.href = `atividadeDetalheProf.html?id=${data.data._id}`;
    }, 1000);

  } catch (error) {
    console.error('Erro ao criar atividade:', error);
    showError(error.message || 'Erro ao criar atividade');
  } finally {
    elements.submitBtn.disabled = false;
    elements.submitBtn.innerHTML = originalText;
  }
}

      // Funções auxiliares
      function getFileIcon(fileType) {
        const icons = {
          'application/pdf': 'fas fa-file-pdf text-red-500',
          'application/msword': 'fas fa-file-word text-blue-500',
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fas fa-file-word text-blue-500',
          'application/vnd.ms-powerpoint': 'fas fa-file-powerpoint text-orange-500',
          'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'fas fa-file-powerpoint text-orange-500'
        };
        return icons[fileType] || 'fas fa-file text-gray-500';
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      function showError(message) {
        const notification = document.createElement('div');
        notification.className = 'notification error';
        notification.innerHTML = `
          <i class="fas fa-exclamation-circle"></i>
          <span>${message}</span>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
      }

      function showSuccess(message) {
        const notification = document.createElement('div');
        notification.className = 'notification success';
        notification.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>${message}</span>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
      }
    </script>
  </body>
</html>