<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeanCore - Dashboard Aluno</title>
    <link rel="stylesheet" href="./css/dashBoardAlun.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos adicionais para melhorar a visualização */
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            padding: 20px;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 24px;
            font-weight: bold;
            color: #4e73df;
        }
        
        .turma-card {
            padding: 15px;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .turma-card:hover {
            transform: translateY(-5px);
        }
        
        .turma-card h3 {
            margin-top: 0;
            color: #333;
        }
        
        .turma-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .turma-stats i {
            margin-right: 5px;
            color: #4e73df;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-pendente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-entregue {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-corrigida {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-atrasada {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .btn-action {
            background-color: #4e73df;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.3s;
        }
        
        .btn-action:hover {
            background-color: #2e59d9;
        }
        
        .btn-action i {
            margin-right: 5px;
        }
        
        .no-data {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .error-message i {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">LeanCore</div>
        <nav>
            <ul class="sidebar-nav">
                <li><a href="dashBoardAlu.html" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="./turmasAlun.html"><i class="fas fa-users"></i>  Turmas</a></li>
                <li><a href="./atividades.html"><i class="fas fa-tasks"></i> Atividades</a></li>
                <li><a href="feedback.html"><i class="fas fa-check-circle"></i> Correções</a></li>
                
                <li><a href="./dadosAluno.html"><i class="fas fa-cog"></i> Configurações</a></li>
               
            </ul>
        </nav>
    </aside>

    <!-- Header -->
    <header class="header">
        <h1>Dashboard do Aluno</h1>
        <div class="header-right">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Pesquisar..." id="searchInput">
            </div>
            <div class="notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
            <div class="user-profile">
                <img src="https://i.pravatar.cc/32" alt="Foto do perfil" class="avatar">
                <span id="alunoName">Carregando...</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Cards de Estatísticas -->
        <div class="stats" id="statsContainer">
            <!-- Será preenchido dinamicamente -->
        </div>

        <!-- Cards de Turmas -->
        <div class="container" id="turmasContainer">
            <!-- Será preenchido dinamicamente -->
        </div>

        <!-- Tabela de Atividades Pendentes -->
        <div class="table-container">
            <div class="table-header">
                <h2>Atividades Pendentes</h2>
                <a href="./atividades.html">Ver todas ></a>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Atividade</th>
                        <th>Turma</th>
                        <th>Data de Entrega</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="atividadesTableBody">
                    <!-- Será preenchido dinamicamente -->
                </tbody>
            </table>
        </div>
    </main>

   <script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/public/loginAluno.html';
        return;
    }

    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };

    try {
        // 1. Carrega dados do usuário
        const userRes = await fetch('http://localhost:3000/api/users/me', { headers });
        
        if (!userRes.ok) {
            if (userRes.status === 401 || userRes.status === 403) {
                localStorage.removeItem('token');
                window.location.href = '/public/loginAluno.html';
                return;
            }
            throw new Error('Erro ao carregar dados do usuário');
        }

        const userData = await userRes.json();

        // ✅ VERIFICAÇÃO DO TIPO DE USUÁRIO
        if (userData.data.role !== 'aluno') {
            // Se não for aluno, redireciona para login de professor
            localStorage.removeItem('token');
            window.location.href = '/public/loginProfessor.html';
            return;
        }

        // Exibe nome do aluno
        document.getElementById('alunoName').textContent = 
            `${userData.data.firstName} ${userData.data.lastName}`;

        // Atualiza avatar
  console.log('Avatar recebido:', userData.data.avatar);

const avatarImg = document.querySelector('.user-profile img');
console.log('Imagem atual antes:', avatarImg.src);

const avatarUrl = userData.data.avatar;
avatarImg.src = avatarUrl.startsWith('http') 
    ? avatarUrl 
    : `http://localhost:3000/uploads/avatars/${avatarUrl}`;

console.log('Imagem atual depois:', avatarImg.src);



        // 2. Carrega turmas do aluno
        const turmasRes = await fetch('http://localhost:3000/api/salas', { headers });
        if (!turmasRes.ok) throw new Error('Erro ao carregar turmas');
        
        const turmasData = await turmasRes.json();
        const turmasDoAluno = turmasData.data?.filter(turma => 
            turma.alunos?.some(aluno => String(aluno._id) === String(userData.data._id))
        ) || [];

        // 3. Carrega todas as tarefas
        const tarefasRes = await fetch('http://localhost:3000/api/tarefas', { headers });
        if (!tarefasRes.ok) throw new Error('Erro ao carregar tarefas');
        
        const tarefasData = await tarefasRes.json();
        const tarefasDoAluno = tarefasData.data?.filter(tarefa => {
            const alunoAtribuido = tarefa.alunosAtribuidos?.some(alunoId => 
                String(alunoId) === String(userData.data._id));
            const emTurmaAtribuida = tarefa.turmas?.some(turmaId => 
                turmasDoAluno.some(turma => String(turma._id) === String(turmaId)));
            return alunoAtribuido || emTurmaAtribuida;
        }) || [];

        // Estatísticas
        const totalTurmas = turmasDoAluno.length || 0;
        const totalTarefas = tarefasDoAluno.length || 0;
        console.log(tarefasDoAluno.map(t => ({
  titulo: t.titulo,
  status: t.status,
  dataEntrega: t.dataEntrega
})));

       // ✅ Calcula tarefas pendentes com base na entrega do aluno
const tarefasPendentes = tarefasDoAluno.filter(tarefa => {
    const entrega = tarefa.entregas?.find(e => String(e.aluno) === String(userData.data._id));
    let status = entrega?.status || 'pendente';
    const atrasada = new Date(tarefa.dataEntrega) < new Date();

    if (status === 'pendente' && atrasada) status = 'atrasada';

    return status === 'pendente' || status === 'ativa' || status === 'atrasada';
}).length || 0;

// Atualiza cards de estatísticas
document.getElementById('statsContainer').innerHTML = `
    <div class="stat-card">
        <h3>Turmas Matriculadas</h3>
        <p>${totalTurmas}</p>
    </div>
    <div class="stat-card">
        <h3>Total de Atividades</h3>
        <p>${totalTarefas}</p>
    </div>
    <div class="stat-card">
        <h3>Atividades Pendentes</h3>
        <p>${tarefasPendentes}</p>
    </div>
`;

// Notificações
document.getElementById('notificationCount').textContent = tarefasPendentes;

// ✅ MANTÉM exibição das turmas do aluno
document.getElementById('turmasContainer').innerHTML = turmasDoAluno.length > 0 
    ? turmasDoAluno.map(turma => `
        <div class="turma-card" onclick="location.href='turmasDetailsAlun.html?id=${turma._id}'">
            <h3>${turma.nome}</h3>
            <p class="turma-desc">${turma.descricao || 'Sem descrição'}</p>
            <div class="turma-stats">
                <span><i class="fas fa-chalkboard-teacher"></i> ${turma.professor?.firstName || 'Professor'}</span>
                <span><i class="fas fa-tasks"></i> ${turma.tarefas?.length || 0}</span>
                <span><i class="fas fa-user-graduate"></i> ${turma.alunos?.length || 0} alunos</span>
            </div>
        </div>
    `).join('')
    : '<p class="no-data">Você não está matriculado em nenhuma turma</p>';

// ✅ Lista as atividades pendentes (últimas 5), considerando entregas do aluno
const atividadesPendentes = tarefasDoAluno
    .map(tarefa => {
        const entrega = tarefa.entregas?.find(e => String(e.aluno) === String(userData.data._id));
        let status = entrega?.status || 'pendente';
        const atrasada = new Date(tarefa.dataEntrega) < new Date();

        if (status === 'pendente' && atrasada) status = 'atrasada';

        return { ...tarefa, entregaStatus: status };
    })
    .filter(tarefa =>
        tarefa.entregaStatus === 'pendente' ||
        tarefa.entregaStatus === 'ativa' ||
        tarefa.entregaStatus === 'atrasada'
    )
    .sort((a, b) => new Date(a.dataEntrega) - new Date(b.dataEntrega))
    .slice(0, 5);

// Atualiza tabela de atividades
document.getElementById('atividadesTableBody').innerHTML = atividadesPendentes.length > 0
    ? atividadesPendentes.map(tarefa => {
        const turma = turmasDoAluno.find(t => 
            String(t._id) === String(tarefa.turmas?.[0]?._id || tarefa.turma?._id));
        
        return `
            <tr>
                <td>${tarefa.titulo}</td>
                <td>${turma?.nome || 'Turma não encontrada'}</td>
                <td>${formatarData(tarefa.dataEntrega)}</td>
                <td><span class="status-badge status-${tarefa.entregaStatus}">${formatarStatus(tarefa.entregaStatus)}</span></td>
                <td>
                    <button class="btn-action" onclick="location.href='atividadeDetalhe.html?id=${tarefa._id}'">
                        <i class="fas fa-upload"></i> Entregar
                    </button>
                </td>
            </tr>
        `;
    }).join('')
    : `<tr><td colspan="5" class="no-data">Nenhuma atividade pendente.<br> </td></tr>`;


    } catch (error) {
        console.error('Erro:', error);
        showError('Erro ao carregar dashboard. Por favor, recarregue a página.');
    }
});

// Funções auxiliares
function formatarData(dataString) {
    if (!dataString) return '-';
    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    return new Date(dataString).toLocaleDateString('pt-BR', options);
}
function formatarStatus(status) {
    switch (status) {
        case 'pendente':
        case 'ativa':
            return 'Pendente';
        case 'entregue':
            return 'Entregue';
        case 'corrigida':
            return 'Corrigida';
        case 'atrasada':
            return 'Atrasada';
        default:
            return status;
    }
}

function showError(message) {
    const main = document.querySelector('.main-content');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
    main.prepend(errorDiv);
}


function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        <span>${message}</span>
    `;
    document.querySelector('main').prepend(errorDiv);
    setTimeout(() => errorDiv.remove(), 5000);
}

// Logout
document.getElementById('logout').addEventListener('click', (e) => {
    e.preventDefault();
    localStorage.removeItem('token');
    window.location.href = '/public/loginAluno.html';
});
</script>

</body>
</html>